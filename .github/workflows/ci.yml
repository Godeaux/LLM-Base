name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- GDScript style checks (gdtoolkit) ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Lint GDScript
        run: |
          GD_FILES=$(find . -name "*.gd" -not -path "./.godot/*" -not -path "./.godot-template/*")
          if [ -n "$GD_FILES" ]; then
            gdlint $GD_FILES
          else
            echo "No GDScript files found."
          fi

      - name: Check GDScript formatting
        run: |
          GD_FILES=$(find . -name "*.gd" -not -path "./.godot/*" -not -path "./.godot-template/*")
          if [ -n "$GD_FILES" ]; then
            gdformat --check $GD_FILES
          else
            echo "No GDScript files found."
          fi

      # --- Godot engine parse/type validation ---
      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: "4.6.0"

      - name: Import Godot project
        run: godot --headless --import --quit 2>&1 || true

      - name: Validate GDScript (parse + type errors)
        run: |
          # Godot returns 0 even on script errors, so we grep the output.
          godot --headless --quit 2>&1 | tee /tmp/godot_validate.log

          if grep -qE "SCRIPT ERROR|Failed to load script" /tmp/godot_validate.log; then
            echo ""
            echo "========================================="
            echo "  GDScript validation FAILED"
            echo "========================================="
            echo ""
            grep -E "SCRIPT ERROR|Failed to load script|Parse Error|Compile Error" /tmp/godot_validate.log
            exit 1
          else
            echo "GDScript validation passed."
          fi
