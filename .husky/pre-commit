#!/bin/sh

# Block commits to game code if .llm/DISCOVERY.md hasn't been filled in.
# This ensures the bootstrap conversation happens before any real game code lands.
# Non-code commits (README fixes, .gitignore updates, etc.) are allowed.
#
# Supports both:
# - Web path (TypeScript): checks src/ directory
# - Godot path (GDScript): checks *.gd files

DISCOVERY=".llm/DISCOVERY.md"

# Detect which path we're on
IS_GODOT=false
if [ -f "project.godot" ] && [ ! -f "package.json" ]; then
  IS_GODOT=true
fi

# Check for staged game code files
if [ "$IS_GODOT" = true ]; then
  # Godot: check for .gd files (excluding templates)
  STAGED_CODE=$(git diff --cached --name-only | grep "\.gd$" | grep -v "^\.godot-template/" || true)
else
  # Web: check for src/ files
  STAGED_CODE=$(git diff --cached --name-only | grep "^src/" || true)
fi

# If no game code files are staged, allow the commit
if [ -z "$STAGED_CODE" ]; then
  exit 0
fi

# Game code files are staged â€” enforce discovery completion

if [ ! -f "$DISCOVERY" ]; then
  echo ""
  echo "COMMIT BLOCKED: .llm/DISCOVERY.md not found."
  echo ""
  echo "You're trying to commit game code, but the bootstrap process"
  echo "hasn't been completed yet."
  echo ""
  echo "Run the bootstrap process first:"
  echo "  1. Open your AI coding editor"
  echo "  2. Describe your game idea"
  echo "  3. Answer the discovery questions"
  echo "  4. The AI will fill in DISCOVERY.md, then you can commit"
  echo ""
  echo "To skip this check (not recommended): git commit --no-verify"
  exit 1
fi

# Check if the template placeholders are still present
if grep -q "_one-sentence description_" "$DISCOVERY" || grep -q "_plays like X meets Y_" "$DISCOVERY" || grep -q "_what the player DOES_" "$DISCOVERY"; then
  echo ""
  echo "COMMIT BLOCKED: .llm/DISCOVERY.md is still in template form."
  echo ""
  echo "You're trying to commit game code, but the bootstrap conversation"
  echo "hasn't been completed yet."
  echo ""
  echo "Before writing game code, the AI needs to ask you questions and fill in"
  echo "the discovery document. Start by describing your game idea."
  echo ""
  echo "Unfilled fields detected in:"
  grep -n "^|.*|.*_.*_.*|" "$DISCOVERY" | head -10
  echo ""
  echo "To skip this check (not recommended): git commit --no-verify"
  exit 1
fi

# --- Godot validation (lint + engine parse check) ---
if [ "$IS_GODOT" = true ]; then

  # Style lint with gdlint (if installed)
  if command -v gdlint > /dev/null 2>&1; then
    echo "Running gdlint on staged GDScript files..."
    echo "$STAGED_CODE" | xargs gdlint || exit 1
  fi

  # Engine-level parse/type validation with Godot headless.
  # Finds Godot via: $GODOT env var > PATH > common install locations.
  GODOT_BIN=""
  if [ -n "$GODOT" ]; then
    GODOT_BIN="$GODOT"
  elif command -v godot > /dev/null 2>&1; then
    GODOT_BIN="godot"
  elif command -v godot.exe > /dev/null 2>&1; then
    GODOT_BIN="godot.exe"
  else
    # Auto-detect: newest Godot exe on Desktop (common for Windows dev setups)
    DESKTOP="$HOME/Desktop"
    if [ -d "$DESKTOP" ]; then
      FOUND=$(ls -1t "$DESKTOP"/Godot_v*.exe 2>/dev/null | head -1)
      if [ -n "$FOUND" ]; then
        GODOT_BIN="$FOUND"
      fi
    fi
  fi

  if [ -n "$GODOT_BIN" ]; then
    echo "Validating GDScript with Godot headless ($GODOT_BIN)..."
    VALIDATE_LOG=$(mktemp)
    "$GODOT_BIN" --headless --quit 2>&1 | tee "$VALIDATE_LOG" > /dev/null

    if grep -qE "SCRIPT ERROR|Failed to load script" "$VALIDATE_LOG"; then
      echo ""
      echo "========================================="
      echo "  COMMIT BLOCKED: GDScript errors found"
      echo "========================================="
      echo ""
      grep -E "SCRIPT ERROR|Failed to load script|Parse Error|Compile Error" "$VALIDATE_LOG"
      echo ""
      echo "Fix the errors above before committing."
      echo "To skip this check (not recommended): git commit --no-verify"
      rm -f "$VALIDATE_LOG"
      exit 1
    fi
    rm -f "$VALIDATE_LOG"
    echo "GDScript validation passed."
  else
    echo "Warning: Godot not found. Skipping engine-level script validation."
    echo "Set the GODOT env var or add Godot to PATH to enable this check."
  fi
fi
